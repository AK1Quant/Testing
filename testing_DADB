fluidRow(
  column(12, align = "center",
         h3("Download Your Processed Data Below!"),
         p("Please ensure that you have completed your analysis and selected the appropriate options before downloading. The downloaded file will contain the processed data and any generated plots."),
         downloadButton("download_btn", "Download", class = "btn-primary"))
)

# Server-side logic for download
output$download_btn <- downloadHandler(
  filename = function() {
    paste("processed_data_with_plots.xlsx")
  },
  content = function(file) {
    req(input$dep_file, input$sheets)

    # Read selected sheet data
    dep_file <- read_excel(input$dep_file$datapath, sheet = input$sheets[1])

    # Perform statistical tests and save within the function
    stats_tests <- function(data, file_path, intercept = TRUE, freq = "monthly", ADF_criteria = "short") {
      # Example processing: Add a new column
      data$Processed <- ifelse(data[[1]] > 0, "Pass", "Fail")

      # Create a workbook
      wb <- createWorkbook()

      # Add processed data to a worksheet
      addWorksheet(wb, "Processed Data")
      writeData(wb, "Processed Data", data)

      # Save the workbook
      saveWorkbook(wb, file_path, overwrite = TRUE)
    }

    # Call the function to process data and save workbook
    stats_tests(dep_file, file, intercept = input$include_intercept, freq = input$frequency, ADF_criteria = input$data_type)
  }
)
